name: Build and Publish Docker Image

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_publish:
        description: Force publish even if not on main branch
        required: false
        default: false
        type: boolean

jobs:
  docker-build-publish:
    # Skip publishing for forked PRs, allow pushes to main and PRs from same repo
    if: github.event.pull_request.head.repo.full_name == github.repository || github.event_name == 'push'
    permissions:
      contents: read
      packages: write
      id-token: write
    uses: druewilding/shared/.github/workflows/docker-build-publish.yml@main
    with:
      service_name: watchthis-user-service
      dockerfile_path: ./Dockerfile
      context_path: .
      registry: ghcr.io
      platforms: linux/amd64,linux/arm64
    secrets:
      REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
